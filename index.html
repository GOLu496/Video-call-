<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StrangerCam - Safe Random Chat</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #E91E63; /* Pink */
            --warning: #ff9800;
            --danger: #f44336;
            --text: #ffffff;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- 1. LEGAL MODAL (SAFETY LAYER) --- */
        #legal-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        .modal-box {
            background: var(--surface); padding: 30px; border-radius: 15px;
            max-width: 500px; width: 100%; text-align: left;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-box h2 { margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .rules-list { margin: 20px 0; font-size: 14px; line-height: 1.6; color: #ccc; }
        .rules-list li { margin-bottom: 10px; }
        .checkbox-group { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; margin-bottom: 15px; }
        .agree-btn {
            width: 100%; padding: 15px; background: #333; color: #777;
            border: none; border-radius: 8px; font-weight: bold; cursor: not-allowed;
            margin-top: 10px; font-size: 16px;
        }
        .agree-btn.active { background: var(--primary); color: white; cursor: pointer; }

        /* --- 2. MAIN INTERFACE --- */
        #app-screen { display: none; height: 100%; flex-direction: column; }

        /* Video Area */
        .video-container {
            flex: 1; position: relative; background: #000;
            display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Remote Video (Stranger) */
        #remote-video { width: 100%; height: 100%; }
        
        /* Local Video (Me) */
        #local-video {
            position: absolute; bottom: 100px; right: 20px;
            width: 100px; height: 140px; background: #222;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 10px;
            transform: scaleX(-1); box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Overlay Status */
        .status-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .loader {
            width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Safety Warning Banner */
        .safety-banner {
            position: absolute; top: 0; width: 100%;
            background: rgba(255, 0, 0, 0.2); color: #ddd;
            font-size: 11px; text-align: center; padding: 5px;
            pointer-events: none;
        }

        /* Controls */
        .controls {
            background: #111; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .main-controls { display: flex; gap: 20px; margin: 0 auto; }
        
        .btn {
            padding: 12px 30px; border-radius: 30px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        
        .btn-skip { background: white; color: black; }
        .btn-stop { background: #333; color: white; }
        
        /* REPORT BUTTON (Crucial) */
        .btn-report {
            background: transparent; border: 1px solid var(--danger);
            color: var(--danger); font-size: 12px; padding: 8px 15px;
        }
        .btn-report:hover { background: var(--danger); color: white; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="legal-modal">
        <div class="modal-box">
            <h2><i class="material-icons">shield</i> Safety Check</h2>
            <p>Before you enter, you must agree to the following rules to ensure a safe environment:</p>
            <ul class="rules-list">
                <li>üîû <b>You must be 18+</b> to use this site.</li>
                <li>üö´ <b>No Nudity or Sexual Content.</b> Violators will be reported.</li>
                <li>ü§ù <b>Be Respectful.</b> Harassment, racism, or bullying is strictly prohibited.</li>
                <li>‚ö†Ô∏è <b>Your Safety.</b> Do not share personal info (Address, Phone).</li>
            </ul>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="check-1" onchange="checkAgreements()">
                    I am 18 years or older.
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="check-2" onchange="checkAgreements()">
                    I agree to the Terms & No Nudity Policy.
                </label>
            </div>
            <button id="enter-btn" class="agree-btn" onclick="enterApp()">START CHATTING</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="video-container">
            <div class="safety-banner">
                ‚ö†Ô∏è MODERATION: Inappropriate behavior will result in an immediate IP ban.
            </div>

            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>

            <div id="status-display" class="status-overlay">
                <div class="loader"></div>
                <h3 id="status-text">Searching for partner...</h3>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-report" onclick="reportUser()">
                <i class="material-icons" style="font-size: 16px;">flag</i> REPORT
            </button>

            <div class="main-controls">
                <button class="btn btn-stop" onclick="stopChat()">STOP</button>
                <button class="btn btn-skip" onclick="skipPartner()">NEXT ‚û°</button>
            </div>
            
            <div style="width: 80px;"></div>
        </div>
    </div>

    <script>
        // --- LEGAL GATE LOGIC ---
        function checkAgreements() {
            const c1 = document.getElementById('check-1').checked;
            const c2 = document.getElementById('check-2').checked;
            const btn = document.getElementById('enter-btn');
            
            if(c1 && c2) {
                btn.classList.add('active');
                btn.removeAttribute('disabled');
            } else {
                btn.classList.remove('active');
            }
        }

        function enterApp() {
            if(!document.getElementById('enter-btn').classList.contains('active')) return;
            document.getElementById('legal-modal').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            startCameraAndPeer();
        }

        // --- CHAT LOGIC ---
        const ID_RANGE = 50; // Pool size
        let myID = null;
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let isSearching = false;
        let searchInterval = null;

        // Google STUN for Connection
        const peerConfig = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };

        function startCameraAndPeer() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                initPeer();
            })
            .catch(err => {
                alert("Camera permission is required to use this app.");
                location.reload();
            });
        }

        function initPeer() {
            myID = "user_" + Math.floor(Math.random() * 100000); // Unique random ID
            peer = new Peer(myID, peerConfig);

            peer.on('open', (id) => {
                console.log("My ID: " + id);
                startSearching();
            });

            peer.on('call', (call) => {
                if (currentCall) return; // Already busy
                
                // Stop searching
                stopSearching();
                document.getElementById('status-display').classList.add('hidden');
                
                call.answer(localStream);
                handleCall(call);
            });
            
            peer.on('error', (err) => {
                console.log(err);
                // Silent retry on error
                if(isSearching) skipPartner();
            });
        }

        // --- SEARCHING ALGORITHM ---
        function startSearching() {
            if (currentCall) currentCall.close();
            currentCall = null;
            isSearching = true;

            // UI Updates
            document.getElementById('status-display').classList.remove('hidden');
            document.getElementById('status-text').innerText = "Searching for partner...";
            document.getElementById('remote-video').srcObject = null;

            // Try to connect to a random ID every 2 seconds
            // Note: We use a smaller range (1-50) for matching logic simulation
            searchInterval = setInterval(() => {
                if (!isSearching) return;

                // Simple logic: Try to call a random user in the 'pool'
                // In a real app without server, users align on ID naming conventions
                // Here we simulate random dialing
                // *For this to work effectively without a server, users need to 'hunt' frequently*
                // Since we don't know who is online, we rely on incoming calls too.
                
                // NOTE: In a pure client-side random chat, waiting for incoming is often better 
                // than dialing blindly. But we will do a mix.
                
            }, 3000); 
        }

        // *IMPROVED MATCHING*: Instead of blind dialing, we will rely on a "Lobby" logic concept
        // Since we don't have a server, we will purely rely on "Wait or Be Called" 
        // OR the previous logic of dialing random numbers 1-50.
        // Let's stick to the previous working Random Dial logic but improved.
        
        // Overwriting startSearching for better matching
        function startSearching() {
            if (currentCall) currentCall.close();
            currentCall = null;
            isSearching = true;

            document.getElementById('status-display').classList.remove('hidden');
            document.getElementById('remote-video').srcObject = null;

            // Clear previous interval
            if(searchInterval) clearInterval(searchInterval);

            searchInterval = setInterval(() => {
                // Generate a random target ID between 0 and 50
                // Everyone listens on "user_xxxx" but we need a common room logic.
                // LIMITATION: Pure P2P random chat is hard without a signaling server list.
                // WORKAROUND: We will use a fixed set of "Rooms".
                // Actually, let's keep the previous logic which you said "Worked Properly".
                
                // Randomly dial a number between 1 and 20 (Higher chance of collision/match)
                let targetId = "random_user_" + Math.floor(Math.random() * 20);
                
                // Don't call myself (We need to use the same naming convention)
                // Let's re-align the ID creation to match the target logic
                
                // ** FIX: To make matching work, MyID must also be in the format 'random_user_X' **
                // But above I set it to 'user_xxxx'. Let's fix initPeer logic below to match.
                
                // (Logic continues below in corrected Init)
                
                let call = peer.call(targetId, localStream);
                
                if(call){
                    call.on('stream', (remoteStream) => {
                        stopSearching();
                        document.getElementById('status-display').classList.add('hidden');
                        handleCall(call);
                    });
                    
                    setTimeout(() => {
                        if(isSearching && !currentCall) call.close();
                    }, 1500);
                }
            }, 2500);
        }
        
        // --- FIXING ID LOGIC FOR MATCHING ---
        // We override the previous initPeer to ensure IDs match the search pool
        function initPeer() {
            // Assign myself a random seat from 1 to 20
            myID = "random_user_" + Math.floor(Math.random() * 20);
            peer = new Peer(myID, peerConfig);

            peer.on('open', (id) => {
                console.log("Joined as: " + id);
                startSearching();
            });

            peer.on('error', (err) => {
                // If ID is taken, try another seat immediately
                if(err.type === 'unavailable-id') {
                    peer.destroy();
                    setTimeout(initPeer, 200);
                }
            });

            peer.on('call', (call) => {
                if (currentCall) return; 
                stopSearching();
                document.getElementById('status-display').classList.add('hidden');
                call.answer(localStream);
                handleCall(call);
            });
        }

        function stopSearching() {
            isSearching = false;
            if(searchInterval) clearInterval(searchInterval);
        }

        function handleCall(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', () => {
                if (!isSearching) skipPartner(); 
            });
        }

        // --- BUTTON ACTIONS ---

        function skipPartner() {
            if (currentCall) currentCall.close();
            startSearching();
        }

        function stopChat() {
            if (currentCall) currentCall.close();
            // Show status
            document.getElementById('status-display').classList.remove('hidden');
            document.getElementById('status-text').innerText = "Paused. Press Next.";
            stopSearching();
        }

        // --- SAFETY: REPORT FUNCTION ---
        function reportUser() {
            if (currentCall) {
                // 1. Close connection immediately
                currentCall.close();
                
                // 2. Alert the user (Feedback)
                alert("User Reported! You will be matched with someone else.");
                
                // 3. Skip to next
                skipPartner();
                
                // (In a real app, you would send the 'peer.id' to a blacklist server here)
            }
        }

    </script>
</body>
</html>
