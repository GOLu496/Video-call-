<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Stranger Chat</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- UI DESIGN --- */
        body {
            margin: 0;
            background-color: #121212;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* START SCREEN */
        #start-screen {
            text-align: center;
            padding: 20px;
            animation: fadeIn 1s ease;
        }
        h1 { margin-bottom: 5px; font-weight: 300; letter-spacing: 2px; }
        p { color: #888; margin-bottom: 40px; }
        
        .main-btn {
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }
        .btn-start {
            background: linear-gradient(45deg, #ff0055, #ff00aa);
            color: white;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 0, 85, 0.6); }

        /* VIDEO SCREEN */
        #video-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            display: none;
            flex-direction: column;
        }

        /* Searching Animation Layer */
        #searching-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader {
            width: 60px; height: 60px;
            border: 5px solid #333;
            border-top: 5px solid #00d2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Videos */
        video { object-fit: cover; }
        #remote-video { width: 100%; height: 100%; }
        #local-video {
            position: absolute; bottom: 20px; right: 20px;
            width: 120px; height: 160px;
            background: #222; border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px; transform: scaleX(-1);
            z-index: 5;
        }

        /* Controls */
        .controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 20px;
            z-index: 20;
        }
        .ctrl-btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .btn-skip { background: white; color: black; }
        .btn-stop { background: #ff3333; color: white; }

    </style>
</head>
<body>

    <!-- SCREEN 1: LANDING -->
    <div id="start-screen">
        <div style="font-size: 60px;">ðŸŒŽ</div>
        <h1>RANDOM TALK</h1>
        <p>Connect with strangers instantly.</p>
        <button class="main-btn btn-start" onclick="startApp()">
            <i class="material-icons">video_call</i> START MATCHING
        </button>
        <p id="status-text" style="margin-top: 20px; font-size: 12px;">Connecting to server...</p>
    </div>

    <!-- SCREEN 2: VIDEO CHAT -->
    <div id="video-screen">
        <!-- Searching Overlay -->
        <div id="searching-layer">
            <div class="loader"></div>
            <h3>Searching for partner...</h3>
            <p style="color: #666;">Please wait while we connect you.</p>
        </div>

        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>

        <div class="controls">
            <button class="ctrl-btn btn-stop" onclick="stopChat()">STOP</button>
            <button class="ctrl-btn btn-skip" onclick="skipPartner()">NEXT âž¡</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // 1-50 IDs ka pool. Agar user base badhana hai to ise 100 kar dein.
        const ID_RANGE = 20; 
        
        let myID = null;
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let isSearching = false;
        let searchInterval = null;

        // Google STUN for Connection
        const peerConfig = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };

        // --- INIT ---
        function generateID() {
            return "random_user_" + Math.floor(Math.random() * ID_RANGE);
        }

        function initPeer() {
            myID = generateID();
            console.log("Attempting ID: " + myID);
            
            peer = new Peer(myID, peerConfig);

            peer.on('open', (id) => {
                document.getElementById('status-text').innerText = "Online. Ready to match.";
                document.getElementById('status-text').style.color = "#00ff00";
            });

            // Agar ID already taken hai (collision), to nayi ID try karo
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    console.log("ID taken, retrying...");
                    peer.destroy();
                    setTimeout(initPeer, 500);
                } else {
                    console.error(err);
                }
            });

            // INCOMING CALL (Match Found!)
            peer.on('call', (call) => {
                // Agar hum search kar rahe hain, tabhi answer karo
                // Agar hum already baat kar rahe hain, to reject karo (simple logic)
                if (currentCall) {
                    // Already busy
                    return; 
                }
                
                stopSearching(); // Search band karo
                
                document.getElementById('searching-layer').style.display = 'none'; // Loader hatao
                
                call.answer(localStream); // Call uthao
                handleCall(call);
            });
        }

        // Initialize on Load
        initPeer();

        // --- APP LOGIC ---

        function startApp() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('video-screen').style.display = 'flex';
            
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                startSearching();
            })
            .catch(err => {
                alert("Camera permission needed!");
                location.reload();
            });
        }

        // --- SEARCH LOGIC (THE HEART OF RANDOM CHAT) ---
        function startSearching() {
            if (currentCall) currentCall.close();
            currentCall = null;
            isSearching = true;

            // UI Reset
            document.getElementById('searching-layer').style.display = 'flex';
            document.getElementById('remote-video').srcObject = null;

            // Har 2 second me ek random user ko dial karo
            searchInterval = setInterval(() => {
                if (!isSearching) return;

                let randomTarget = "random_user_" + Math.floor(Math.random() * ID_RANGE);
                
                // Khud ko call mat karo
                if (randomTarget === myID) return;

                console.log("Dialing: " + randomTarget);
                
                let call = peer.call(randomTarget, localStream);

                // Agar connection establish ho jaye
                call.on('stream', (remoteStream) => {
                    stopSearching();
                    document.getElementById('searching-layer').style.display = 'none';
                    handleCall(call);
                });

                // Agar user offline ho (PeerJS usually error deta hai timeout ke baad)
                // Hum bas try karte rahenge.
                setTimeout(() => {
                    if (isSearching && !currentCall) {
                        call.close(); // Cancel this attempt and try next
                    }
                }, 1500); // 1.5 second wait karo phir agla try karo

            }, 2000);
        }

        function stopSearching() {
            isSearching = false;
            clearInterval(searchInterval);
        }

        function handleCall(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', () => {
                // Agar samne wala kat de, to wapas search shuru karo
                if (!isSearching) skipPartner(); 
            });
        }

        // --- BUTTONS ---

        function skipPartner() {
            if (currentCall) currentCall.close();
            startSearching(); // Dubara naya dhundo
        }

        function stopChat() {
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            location.reload();
        }

    </script>
</body>
</html>
